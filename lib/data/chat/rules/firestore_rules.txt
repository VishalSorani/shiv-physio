rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUserAuthenticated(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isConversationParticipant(conversationId) {
      let conversation = get(/databases/$(database)/documents/conversations/$(conversationId));
      return isAuthenticated() && 
             request.auth.uid in conversation.data.participantIds;
    }
    
    function isConversationAdmin(conversationId) {
      let conversation = get(/databases/$(database)/documents/conversations/$(conversationId));
      return isAuthenticated() && 
             (conversation.data.adminId == request.auth.uid || 
             conversation.data.participantData[request.auth.uid].role == "admin");
    }
    
    function isConversationModerator(conversationId) {
      let conversation = get(/databases/$(database)/documents/conversations/$(conversationId));
      return isAuthenticated() && 
             conversation.data.participantData[request.auth.uid].role == "moderator";
    }
    
    function canAdministerConversation(conversationId) {
      return isConversationAdmin(conversationId) || isConversationModerator(conversationId);
    }
    
    function isMessageSender(conversationId, messageId) {
      let message = get(/databases/$(database)/documents/conversations/$(conversationId)/messages/$(messageId));
      return isAuthenticated() && 
             message.data.senderId == request.auth.uid;
    }
    
    // User profiles
    match /users/{userId} {
      // Anyone can read basic user profiles
      allow read: if isAuthenticated();
      
      // Users can only update their own profile
      allow create, update, delete: if isUserAuthenticated(userId);
    }
    
    // Conversations
    match /conversations/{conversationId} {
      // Only participants can read a conversation
      allow read: if isConversationParticipant(conversationId);
      
      // Any authenticated user can create a conversation
      allow create: if isAuthenticated() && 
                      request.resource.data.participantIds.hasAll([request.auth.uid]);
      
      // Only admins/moderators can update conversation details
      allow update: if isConversationParticipant(conversationId) && (
                       // Participants can update only their own data
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['participantData.' + request.auth.uid]) ||
                       // Or admins/moderators can make broader changes
                       canAdministerConversation(conversationId)
                     );
      
      // Only admins can delete a conversation
      allow delete: if isConversationAdmin(conversationId);
      
      // Messages within a conversation
      match /messages/{messageId} {
        // Only participants can read messages in a conversation
        allow read: if isConversationParticipant(conversationId);
        
        // Only participants can send messages
        allow create: if isConversationParticipant(conversationId) && 
                        request.resource.data.senderId == request.auth.uid;
        
        // Message owners can edit their own messages, admins can delete any message
        // FIXED: Allow participants to update readStatus field for their own user ID
        allow update: if (isMessageSender(conversationId, messageId) && 
                         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['senderId', 'conversationId', 'timestamp'])) || 
                        canAdministerConversation(conversationId) ||
                        (isConversationParticipant(conversationId) && 
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readStatus.' + request.auth.uid]));
        
        // Only message sender or admins can delete a message
        allow delete: if isMessageSender(conversationId, messageId) || 
                        canAdministerConversation(conversationId);
      }
    }
    
    // Reports
    match /reports/{reportId} {
      // Any authenticated user can create a report
      allow create: if isAuthenticated() && 
                      request.resource.data.reportedBy == request.auth.uid;
      
      // Only the reporter can read their own reports
      allow read: if isAuthenticated() && 
                    resource.data.reportedBy == request.auth.uid;
      
      // No one can update or delete reports directly (admin-only via functions)
      allow update, delete: if false;
    }
    
    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 